#!/system/bin/sh

# MagiskHide Props Config
# By Didgeridoohan @ XDA Developers

# This is a script file for the Magisk module "MagiskHide Props Config" By Didgeridoohan @ XDA Developers.
# DO NOT DELETE!
# Unless: If you don't have the module installed something has gone horribly wrong and this file is an orphan.
# In that case, feel free to delete it.

# Script version
SCRIPTV=5
SETTRANSF=1

# Variables
IMGPATH=IMG_PLACEHOLDER
MODPATH=$IMGPATH/MagiskHidePropsConf

FINGERPRINTENB=1
PRINTEDIT=0
BUILDPROPENB=1
FILESAFE=1
BUILDEDIT=0
DEFAULTEDIT=0
PROPCOUNT=0
PROPEDIT=0
CUSTOMEDIT=0
REBOOTCHK=0
OPTIONCOLOUR=1
OPTIONWEB=1

# Function to clean up different files after the module has been uninstalled
cleanup() {
	CACHELOC=CACHE_PLACEHOLDER
	rm -f $CACHELOC/propsconf.log
	rm -f $CACHELOC/propsconf_last.log
	rm -f $CACHELOC/propsconf_conf
	rm -f $CACHELOC/reset_mhpc
	# Suicide.
	rm $0
}

# Checks if the module is installed. Deletes itself if it isn't.
if [ -d "$MODPATH" ]; then
	# Checks if the module is set for removal
	if [ -f "$MODPATH/remove" ]; then		
		# Cleanup
		cleanup
	else
		# Load functions
		. $MODPATH/util_functions.sh

		log_script_chk "Running boot script."

		if [ -f "$MODPATH/disable" ]; then
			log_handler "Module disabled."
		else
			# Checks for the Universal SafetyNet Fix module and similar modules editing the device fingerprint
			PRINTMODULE=false
			for USNF in $USNFLIST; do
				if [ -d "$IMGPATH/$USNF" ]; then
					NAME=$(get_file_value $IMGPATH/$USNF/module.prop "name=")
					log_handler "'$NAME' installed (modifies the device fingerprint)."
					PRINTMODULE=true
				fi
			done
			if [ "$PRINTMODULE" == "true" ]; then
				replace_fn FINGERPRINTENB 1 0 $LATEFILE
				log_handler "Fingerprint modification disabled."
			else
				replace_fn FINGERPRINTENB 0 1 $LATEFILE
			fi
			
			# Check the reboot variable
			if [ "$(get_file_value $LATEFILE "REBOOTCHK\=")" == 1 ]; then
				replace_fn REBOOTCHK 1 0 $LATEFILE
			fi

			# ---Original values---
			# default.prop
			FILEDEBUGGABLE=""
			FILESECURE=""
			# build.prop
			FILETYPE=""
			FILETAGS=""
			FILESELINUX=""
			FILEFINGERPRINT=""

			# ---Module values---
			MODULEDEBUGGABLE=""
			MODULESECURE=""
			MODULETYPE=""
			MODULETAGS=""
			MODULESELINUX=""
			MODULEFINGERPRINT=""

			# ---Custom prop values---
			CUSTOMPROPS=""

			# ---MagiskHide sensitive props---
			REDEBUGGABLE=false
			RESECURE=false
			RETYPE=false
			RETAGS=false
			RESELINUX=false

			# ---Editing default.prop---
			SETDEBUGGABLE=false
			SETSECURE=false

			# ---Editing build.prop---
			SETTYPE=false
			SETTAGS=false
			SETSELINUX=false
			SETFINGERPRINT=false

			# ---Setting/Changing props---
			# Set/change MagiskHide sensitive props
			if [ "$PROPEDIT" == 1 ]; then
				log_handler "Changing sensitive props."
				for ITEM in $PROPSLIST; do
					PROP=$(get_prop_type $ITEM)
					REPROP=$(echo "RE${PROP}" | tr '[:lower:]' '[:upper:]')
					MODULEPROP=$(echo "MODULE${PROP}" | tr '[:lower:]' '[:upper:]')
					if [ "$(eval "echo \$$REPROP")" == "true" ]; then
						log_handler "Changing/writing $ITEM."
						resetprop -v $ITEM 2>> $LOGFILE
						resetprop -v $ITEM $(eval "echo \$$MODULEPROP") 2>> $LOGFILE
					fi
				done
			fi
			# Set new fingerprint
			if [ "$FINGERPRINTENB" == 1 -o "$PRINTMODULE" == "false" ] && [ "$PRINTEDIT" == 1 ]; then
				log_handler "Changing fingerprint."
				for ITEM in $PRINTPROPS; do
					log_handler "Changing/writing $ITEM."
					resetprop -v $ITEM 2>> $LOGFILE
					resetprop -v $ITEM $MODULEFINGERPRINT 2>> $LOGFILE
				done				
			fi

			# ---Setting custom props---
			if [ "$CUSTOMEDIT" == 1 ]; then
				log_handler "Writing custom props."
				for ITEM in $CUSTOMPROPS; do
					log_handler "Changing/writing $(get_eq_left $ITEM)."
					resetprop -v $(get_eq_left $ITEM) 2>> $LOGFILE
					resetprop -v $(get_eq_left $ITEM) $(get_eq_right $ITEM) 2>> $LOGFILE
				done
			fi

			# ---Edits default.prop---
			if [ "$DEFAULTEDIT" == 1 ] && [ "$FILESAFE" == 0 ]; then
				log_handler "Editing default.prop."
				mount -wo remount rootfs /
				if [ "$MODULEDEBUGGABLE" ]; then
					SEDDEBUGGABLE="$MODULEDEBUGGABLE"
				else
					SEDDEBUGGABLE="0"
				fi
				if [ "$SETDEBUGGABLE" == "true" ]; then
					replace_fn "ro.debuggable" $FILEDEBUGGABLE $SEDDEBUGGABLE /default.prop && log_handler "ro.debuggable=$SEDDEBUGGABLE"
				fi
				if [ "$MODULESECURE" ]; then
					SEDSECURE="$MODULESECURE"
				else
					SEDSECURE="1"
				fi
				if [ "$SETSECURE" == "true" ]; then
					replace_fn "ro.secure" $FILESECURE $SEDSECURE /default.prop && log_handler "ro.secure=$SEDSECURE"
				fi
				mount -ro remount rootfs /
			else
				log_handler "Default.prop editing disabled."
			fi			
		fi
		log_script_chk "Boot script finished.\n\n=================="
	fi
else
	# Cleanup
	cleanup
fi
